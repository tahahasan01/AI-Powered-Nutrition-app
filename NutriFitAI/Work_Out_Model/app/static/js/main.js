document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("user-form");
  const resultContainer = document.getElementById("result");

  if (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      const res = await fetch("/workout/generate_plan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (data.html) {
        resultContainer.innerHTML = data.html;
        attachSwapHandlers();
        renderCharts(data.chartData);
      } else {
        console.error("No HTML response received:", data);
      }
    });
  }

  function attachSwapHandlers() {
    document.querySelectorAll(".swap-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const current = JSON.parse(btn.dataset.exercise);
        const preference = btn.dataset.preference;
        const res = await fetch("/workout/swap_exercise", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ current, preference }),
        });
        const data = await res.json();
        const list = btn.closest(".exercise-item").querySelector(".alternatives");
        list.innerHTML = data.alternatives
          .map(
            (ex) => `<li><strong>${ex.Exercise_Name}</strong> - ${ex.Equipment} - ${ex.Difficulty}</li>`
          )
          .join("");
      });
    });
  }

  function renderCharts(chartData) {
    if (!chartData) return;
    const pieCtx = document.getElementById("goalPie");
    const barCtx = document.getElementById("calorieBar");
    const monthlyCtx = document.getElementById("monthlyBar");
    const progressSummary = document.getElementById("progressSummary");

    if (progressSummary && chartData.summary) {
      progressSummary.textContent = chartData.summary;
    }

    if (pieCtx && window.Chart) {
      new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: chartData.pie.labels,
          datasets: [
            { data: chartData.pie.values, backgroundColor: chartData.pie.colors || ["#e74c3c", "#3498db", "#2ecc71", "#f1c40f"] },
          ],
        },
      });
    }

    if (barCtx && window.Chart) {
      new Chart(barCtx, {
        type: "bar",
        data: {
          labels: chartData.bar.labels,
          datasets: [
            { label: "Calories (per day)", data: chartData.bar.values, backgroundColor: "#36a2eb" },
          ],
        },
        options: { scales: { y: { beginAtZero: true } } },
      });
    }

    if (monthlyCtx && window.Chart) {
      new Chart(monthlyCtx, {
        type: "bar",
        data: {
          labels: chartData.monthly.labels,
          datasets: [
            { label: "Calories", data: chartData.monthly.calories, backgroundColor: "#8e44ad" },
          ],
        },
        options: {
          plugins: {
            title: { display: true, text: `30-day calories; est. weight change: ${chartData.monthly.kgChange.toFixed(2)} kg` },
          },
          scales: { y: { beginAtZero: true } },
        },
      });
    }
  }

  const pdfBtn = document.getElementById("download-pdf");
  if (pdfBtn) {
    pdfBtn.addEventListener("click", () => {
      // Create a new window for printing
      const printWindow = window.open('', '_blank');
      const content = document.querySelector('.container').innerHTML;
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Workout Plan - NutriFit</title>
          <style>
            body { font-family: 'Poppins', sans-serif; margin: 20px; }
            .card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
            .exercise-item { border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px; }
            .badge { background: #e8f5e9; color: #2ecc71; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
            h1, h2, h3 { color: #2ecc71; }
            .section-title { font-size: 24px; margin-bottom: 20px; }
            @media print { body { margin: 0; } }
          </style>
        </head>
        <body>
          <h1>Your Personalized Workout Plan</h1>
          <p><strong>Generated by NutriFit Pakistan</strong></p>
          ${content}
        </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 250);
    });
  }
});
